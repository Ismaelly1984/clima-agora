const USE_PROXY=!0,API_BASE="/api/weather",FORECAST_BASE="/api/forecast",POP_HIGHLIGHT=60,RAIN_MM_HIGHLIGHT=5,el={body:document.body,main:document.getElementById("main"),cityInput:document.getElementById("cityInput"),searchBtn:document.getElementById("searchBtn"),geoBtn:document.getElementById("geoBtn"),unitToggle:document.getElementById("unitToggle"),installBtn:document.getElementById("installBtn"),statusMsg:document.getElementById("statusMsg"),weatherCard:document.getElementById("weatherCard"),cityName:document.getElementById("cityName"),country:document.getElementById("country"),weatherIcon:document.getElementById("weatherIcon"),description:document.getElementById("description"),temp:document.getElementById("temp"),humidity:document.getElementById("humidity"),wind:document.getElementById("wind"),toast:document.getElementById("toast"),themeToggle:document.getElementById("themeToggle"),forecastSection:null,forecastRow:null,historyList:null,moodLine:null,todaySection:null,todayRow:null,todayEmpty:null,todayNoRain:null,popSummaryVal:null,rainSummaryVal:null,popSummaryBox:null,rainSummaryBox:null},kmh=e=>3.6*e,mph=e=>e,capitalize=e=>e?e[0].toUpperCase()+e.slice(1):e;function getIdleTimeout(){try{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(e){if(e.saveData)return 1500;const t=String(e.effectiveType||"").toLowerCase();if(t.includes("2g")||t.includes("slow"))return 1500;if(t.includes("3g"))return 900}}catch{}return 300}function inIdle(e,t=getIdleTimeout()){return"requestIdleCallback"in window?requestIdleCallback(e,{timeout:t}):setTimeout(e,Math.min(t,300))}function setTheme(e="auto"){if(el.body.classList.remove("theme-light"),el.body.classList.remove("theme-auto"),"auto"===e){el.body.classList.add("theme-auto");const e=(new Date).getHours();e>=6&&e<18&&el.body.classList.add("theme-light")}else"light"===e&&el.body.classList.add("theme-light");localStorage.setItem("themePref",e),updateThemeToggleIcon(e)}function updateThemeToggleIcon(e){let t="moon";"auto"===e?t="moon":"dark"===e?t="sun":"light"===e&&(t="moon"),el.themeToggle.innerHTML=svgIcon(t)}function cycleTheme(){const e=localStorage.getItem("themePref")||"auto";setTheme("auto"===e?"light":"light"===e?"dark":"auto")}function svgIcon(e,t=20,n=""){return`<svg aria-hidden="true" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${n}"><use href="#i-${e}"/></svg>`}function getUnits(){return"imperial"===(localStorage.getItem("unitsPref")||"metric").toLowerCase()?"imperial":"metric"}function setUnits(e){localStorage.setItem("unitsPref",e),updateUnitToggleUI()}function toggleUnits(){setUnits("metric"===getUnits()?"imperial":"metric");const e=localStorage.getItem("lastCity");e&&fetchWeatherByCity(e)}function updateUnitToggleUI(){const e=getUnits();el.unitToggle&&(el.unitToggle.textContent="metric"===e?"Â°C / Â°F":"Â°F / Â°C")}let toastTimer;function showToast(e,t="info",n=2400){el.toast.textContent=e,el.toast.className=`toast ${t} show`,clearTimeout(toastTimer),toastTimer=setTimeout((()=>{el.toast.classList.remove("show")}),n)}function setLoading(e){e?(el.searchBtn.disabled=!0,el.searchBtn.style.opacity=.75,el.statusMsg.textContent="Carregando...",el.main&&el.main.setAttribute("aria-busy","true")):(el.searchBtn.disabled=!1,el.searchBtn.style.opacity=1,el.main&&el.main.removeAttribute("aria-busy"))}function startSkeleton(){el.weatherCard.classList.remove("hidden"),el.weatherCard.classList.add("visible"),[el.cityName,el.country,el.description,el.temp,el.humidity,el.wind].forEach((e=>e&&e.classList.add("skel","skel-line-md"))),el.weatherIcon&&el.weatherIcon.classList.add("skel","skel-square")}function stopSkeleton(){[el.cityName,el.country,el.description,el.temp,el.humidity,el.wind].forEach((e=>e&&e.classList.remove("skel","skel-line-md"))),el.weatherIcon&&el.weatherIcon.classList.remove("skel","skel-square")}function setupDynamicSections(){if(!el.moodLine){const e=document.querySelector("#weatherCard .place");if(e){const t=document.createElement("p");t.id="moodLine",t.className="mood muted",e.appendChild(t),el.moodLine=t}}if(!el.forecastSection){const e=document.createElement("section");e.id="forecastSection",e.className="forecast-section glass hidden",e.innerHTML='\n      <div class="forecast-header">\n        <h3 class="forecast-title">PrÃ³ximos dias</h3>\n      </div>\n      <div id="forecastRow" class="forecast-row" aria-live="polite"></div>\n    ';const t=el.weatherCard;t&&t.parentElement&&(t.insertAdjacentElement("afterend",e),el.forecastSection=e,el.forecastRow=e.querySelector("#forecastRow"))}if(!el.todaySection){const e=document.createElement("section");e.id="todaySection",e.className="today-section glass hidden",e.innerHTML='\n      <div class="forecast-header">\n        <h3 class="forecast-title">PrevisÃ£o de Hoje (3h em 3h)</h3>\n      </div>\n      <div id="todayRow" class="today-row" aria-live="polite"></div>\n      <p id="todayEmpty" class="muted hidden">Sem dados para hoje</p>\n      <p id="todayNoRain" class="muted hidden">Sem dados de chuva</p>\n    ';const t=document.querySelector(".container"),n=el.forecastSection||el.weatherCard;t&&n&&(n.insertAdjacentElement("afterend",e),el.todaySection=e,el.todayRow=e.querySelector("#todayRow"),el.todayEmpty=e.querySelector("#todayEmpty"),el.todayNoRain=e.querySelector("#todayNoRain"))}if(!el.historyList){const e=document.querySelector(".search-card");if(e){const t=document.createElement("div");t.id="historyList",t.className="history hidden",e.appendChild(t),el.historyList=t,el.historyList.addEventListener("click",(e=>{const t=e.target.closest(".chip");if(t){const e=t.getAttribute("data-city");e&&fetchWeatherByCity(e)}}))}}ensureRainSummaryMetrics()}function ensureRainSummaryMetrics(){const e=document.querySelector(".weather-extra");if(e){if(!el.popSummaryVal){const t=document.createElement("div");t.className="metric",t.innerHTML=`\n      ${svgIcon("umbrella",22)}\n      <div>\n        <span class="label">Chance de chuva</span>\n        <span id="popSummaryVal" class="value">â€”</span>\n      </div>\n    `,e.appendChild(t),el.popSummaryVal=t.querySelector("#popSummaryVal"),el.popSummaryBox=t}if(!el.rainSummaryVal){const t=document.createElement("div");t.className="metric",t.innerHTML=`\n      ${svgIcon("cloud-rain",22)}\n      <div>\n        <span class="label">Chuva (mm hoje)</span>\n        <span id="rainSummaryVal" class="value">â€”</span>\n      </div>\n    `,e.appendChild(t),el.rainSummaryVal=t.querySelector("#rainSummaryVal"),el.rainSummaryBox=t}window.lucide&&lucide.createIcons()}}function clearWeatherCard(){el.cityName.textContent="",el.country.textContent="",el.description.textContent="",el.temp.textContent="",el.humidity.textContent="",el.wind.textContent="",el.weatherIcon.src="",el.weatherIcon.alt="",el.weatherCard.classList.add("hidden"),el.weatherCard.classList.remove("visible"),el.popSummaryVal&&(el.popSummaryVal.textContent="â€”"),el.rainSummaryVal&&(el.rainSummaryVal.textContent="â€”"),el.popSummaryBox&&el.popSummaryBox.classList.remove("rainy","likely"),el.rainSummaryBox&&el.rainSummaryBox.classList.remove("rainy","likely")}function showWeatherCard(){el.weatherCard.classList.remove("hidden"),requestAnimationFrame((()=>{el.weatherCard.classList.add("visible")}))}function removeAllBgClasses(){["bg-clear","bg-clouds","bg-rain","bg-snow","bg-thunder","bg-mist"].forEach((e=>el.body.classList.remove(e)))}function setBackgroundByWeather(e,t){removeAllBgClasses();const n=(e||"").toLowerCase();return n.includes("thunder")?el.body.classList.add("bg-thunder"):n.includes("drizzle")||n.includes("rain")?el.body.classList.add("bg-rain"):n.includes("snow")?el.body.classList.add("bg-snow"):n.includes("mist")||n.includes("fog")||n.includes("haze")||n.includes("smoke")?el.body.classList.add("bg-mist"):n.includes("cloud")?el.body.classList.add("bg-clouds"):void el.body.classList.add("bg-clear")}function getBgKey(e){const t=(e||"").toLowerCase();return t.includes("drizzle")||t.includes("rain")?"rain":t.includes("thunder")?"thunderstorm":t.includes("snow")?"snow":t.includes("mist")||t.includes("fog")||t.includes("haze")||t.includes("smoke")?"mist":t.includes("cloud")?"clouds":"clear"}async function setDynamicBackgroundImage(e){const t=getBgKey(e),n=[`assets/bg/${t}.webp`,`assets/bg/${t}.png`,`assets/bg/${t}.jpg`,`assets/bg/${t}.jpeg`];function o(e){return new Promise((t=>{const n=new Image;n.onload=()=>t(e),n.onerror=()=>t(null),n.src=e}))}let a=null;for(const e of n){const t=await o(e);if(t){a=t;break}}a?(document.body.style.backgroundImage=`linear-gradient(0deg, var(--image-overlay), var(--image-overlay)), url('${a}')`,document.body.style.backgroundAttachment="fixed, fixed",document.body.style.backgroundSize="cover, cover",document.body.style.backgroundPosition="center, center"):document.body.style.backgroundImage=""}function getMoodPhrase(e,t,n){const o=(e||"").toLowerCase(),a="number"==typeof t?t:null,i="imperial"===n?null!==a&&a>=86:null!==a&&a>=30,s="imperial"===n?null!==a&&a<=50:null!==a&&a<=10;return o.includes("thunder")?"Tempestade chegando â€” fique em local seguro âš¡":o.includes("drizzle")||o.includes("rain")?"Vai chover! Pegue o guarda-chuva â˜”":o.includes("snow")?"Neve Ã  vista â€” agasalhe-se bem â„ï¸":o.includes("mist")||o.includes("fog")||o.includes("haze")?"Neblina Ã  vista â€” dirija com cuidado ðŸŒ«ï¸":o.includes("cloud")?"Nuvens pelo cÃ©u â€” clima ameno â›…":o.includes("clear")?i?"Sol forte â€” beba Ã¡gua e use protetor â˜€ï¸":s?"CÃ©u limpo e frio â€” cachecol cai bem ðŸ§£":"CÃ©u limpo â€” um Ã³timo dia para sair! â˜€ï¸":"Tempo variado â€” aproveite com moderaÃ§Ã£o ðŸŒ¤ï¸"}function renderMood(e,t){if(!el.moodLine)return;const n=getMoodPhrase(e,t,getUnits());el.moodLine.textContent=n,el.moodLine.classList.remove("fade-in"),el.moodLine.offsetWidth,el.moodLine.classList.add("fade-in")}function updateUI(e){const t=e.name,n=e.sys?.country||"",{temp:o,humidity:a}=e.main||{},i=e.wind?.speed??0,s=e.weather?.[0]||{};el.cityName.textContent=t||"â€”",el.country.textContent=n||"â€”",el.description.textContent=capitalize(s.description||"â€”");const r=getUnits(),l="imperial"===r?"Â°F":"Â°C";if(el.temp.textContent="number"==typeof o?`${o.toFixed(1)}${l}`:"â€”",el.humidity.textContent="number"==typeof a?`${a}%`:"â€”",el.wind.textContent="imperial"===r?`${mph(e.wind?.speed??0).toFixed(0)} mph`:`${kmh(i).toFixed(0)} km/h`,s.icon){const e=`https://openweathermap.org/img/wn/${s.icon}@4x.png`;el.weatherIcon.src=e;const t=capitalize(s.description||"");el.weatherIcon.alt=t?`CondiÃ§Ã£o do tempo: ${t}`:"CondiÃ§Ã£o do tempo"}else el.weatherIcon.src="",el.weatherIcon.alt="";setBackgroundByWeather(s.main||"",s.icon||""),setDynamicBackgroundImage(s.main||""),showWeatherCard(),stopSkeleton(),renderMood(s.main||"",o)}async function fetchWeatherByCity(e){const t=e?.trim();if(t)if(navigator.onLine)try{setLoading(!0),startSkeleton(),startTodaySkeleton();const e=`${API_BASE}?q=${encodeURIComponent(t)}&units=${getUnits()}&lang=pt_br`,n=await fetch(e);if(!n.ok){let e="Erro ao buscar dados.";try{const t=await n.json();t?.message&&(e=t.message)}catch{}throw 401===n.status&&(e="API key invÃ¡lida ou nÃ£o ativada. Verifique sua conta no OpenWeather."),404===n.status&&(e="Cidade nÃ£o encontrada."),new Error(e)}const o=await n.json();updateUI(o),el.statusMsg.textContent=`${o.name}, ${o.sys?.country||""}`,localStorage.setItem("lastCity",o.name),addCityToHistory(o.name),inIdle((()=>fetchForecastByCity(o.name)))}catch(e){clearWeatherCard(),el.statusMsg.textContent=e.message||"Erro ao buscar dados.",showToast(el.statusMsg.textContent,"error",3200)}finally{setLoading(!1),stopSkeleton()}else showToast("Sem conexÃ£o. Verifique sua internet.","error");else showToast("Digite o nome de uma cidade.","info")}async function fetchWeatherByCoords(e,t){if(navigator.onLine)try{setLoading(!0),startSkeleton(),startTodaySkeleton();const n=`${API_BASE}?lat=${e}&lon=${t}&units=${getUnits()}&lang=pt_br`,o=await fetch(n);if(!o.ok)throw new Error("Erro ao buscar localizaÃ§Ã£o atual.");const a=await o.json();updateUI(a),el.statusMsg.textContent=`${a.name}, ${a.sys?.country||""}`,localStorage.setItem("lastCity",a.name),addCityToHistory(a.name),inIdle((()=>fetchForecastByCoords(e,t)))}catch(e){clearWeatherCard(),el.statusMsg.textContent=e.message||"Erro na geolocalizaÃ§Ã£o.",showToast(el.statusMsg.textContent,"error",3200)}finally{setLoading(!1),stopSkeleton()}else showToast("Sem conexÃ£o. Verifique sua internet.","error")}function toLocalDate(e,t){return new Date(1e3*(e+(t||0)))}function pad(e){return e.toString().padStart(2,"0")}function dateKeyISO(e){return`${e.getUTCFullYear()}-${pad(e.getUTCMonth()+1)}-${pad(e.getUTCDate())}`}function weekdayPT(e){return["Dom","Seg","Ter","Qua","Qui","Sex","SÃ¡b"][e.getUTCDay()]}function pickIconForDay(e){const t=e.find((e=>(e.dt_txt||"").includes("12:00:00")));return(t||e[Math.floor(e.length/2)]||e[0]).weather?.[0]?.icon||"01d"}function groupForecast(e){const t=e.city?.timezone||0,n=new Map;for(const o of e.list||[]){const e=dateKeyISO(toLocalDate(o.dt,t));n.has(e)||n.set(e,[]),n.get(e).push(o)}const o=[];for(const[e,a]of n){let n=1/0,i=-1/0;a.forEach((e=>{"number"==typeof e.main?.temp_min&&(n=Math.min(n,e.main.temp_min)),"number"==typeof e.main?.temp_max&&(i=Math.max(i,e.main.temp_max))}));const s=pickIconForDay(a),r=toLocalDate(a[0].dt,t);o.push({key:e,date:r,min:n,max:i,icon:s})}return o.sort(((e,t)=>e.date-t.date)),o.slice(0,5)}function startForecastSkeleton(){if(el.forecastSection&&el.forecastRow){el.forecastSection.classList.remove("hidden"),el.forecastRow.innerHTML="";for(let e=0;e<5;e++){const e=document.createElement("div");e.className="forecast-card",e.innerHTML='\n      <div class="skel skel-square" style="width:56px;height:56px;margin:0 auto;border-radius:12px"></div>\n      <div class="skel skel-line-sm" style="width:60%;height:14px;margin:10px auto 6px"></div>\n      <div class="skel skel-line-sm" style="width:70%;height:14px;margin:0 auto"></div>\n    ',el.forecastRow.appendChild(e)}}}function renderForecast(e){if(!el.forecastSection||!el.forecastRow)return;const t="imperial"===getUnits()?"Â°F":"Â°C";try{const n=groupForecast(e);el.forecastRow.innerHTML="",n.forEach((e=>{const n=document.createElement("div");n.className="forecast-card";const o=`https://openweathermap.org/img/wn/${e.icon}@2x.png`,a=weekdayPT(e.date),i=new Image;i.src=o,i.className="f-icon",i.loading="lazy",i.decoding="async",i.width=56,i.height=56;const s=document.createElement("div");s.className="f-day",s.textContent=a;const r=document.createElement("div");r.className="f-temps";const l=document.createElement("span");l.className="min",l.textContent=`${Math.round(e.min)}${t}`;const c=document.createTextNode(" Â· "),d=document.createElement("span");d.className="max",d.textContent=`${Math.round(e.max)}${t}`,r.append(l,c,d),n.replaceChildren(i,s,r),el.forecastRow.appendChild(n)})),el.forecastSection.classList.remove("hidden")}catch(e){el.forecastSection.classList.add("hidden")}}async function fetchForecastByCity(e){if(e)try{startForecastSkeleton();const t=`${FORECAST_BASE}?q=${encodeURIComponent(e)}&units=${getUnits()}&lang=pt_br`,n=await fetch(t);if(!n.ok)throw new Error("Falha ao buscar previsao");const o=await n.json();renderForecast(o),renderTodayForecast(o),renderTodayRainSummary(o)}catch(e){el.forecastSection?.classList.add("hidden");try{showToast("Nao foi possivel obter a previsao estendida.","info",2200)}catch{}}}async function fetchForecastByCoords(e,t){try{startForecastSkeleton();const n=`${FORECAST_BASE}?lat=${e}&lon=${t}&units=${getUnits()}&lang=pt_br`,o=await fetch(n);if(!o.ok)throw new Error("Falha ao buscar previsao");const a=await o.json();renderForecast(a),renderTodayForecast(a),renderTodayRainSummary(a)}catch(e){el.forecastSection?.classList.add("hidden");try{showToast("Nao foi possivel obter a previsao estendida.","info",2200)}catch{}}}function renderTodayRainSummary(e){ensureRainSummaryMetrics();const t=e.city?.timezone||0,n=dateKeyISO(new Date(Date.now()+1e3*t)),o=(e.list||[]).filter((e=>dateKeyISO(toLocalDate(e.dt,t))===n));if(!o.length)return el.popSummaryVal&&(el.popSummaryVal.textContent="â€”"),void(el.rainSummaryVal&&(el.rainSummaryVal.textContent="â€”"));let a=0,i=0;for(const e of o){"number"==typeof e.pop&&(a=Math.max(a,e.pop));i+=e.rain&&"number"==typeof e.rain["3h"]?e.rain["3h"]:0}const s=Math.round(100*a);el.popSummaryVal&&(el.popSummaryVal.textContent=`${s}%`),el.rainSummaryVal&&(el.rainSummaryVal.textContent=`${i.toFixed(1)} mm`),el.popSummaryBox&&(el.popSummaryBox.classList.remove("rainy","likely"),s>=POP_HIGHLIGHT&&el.popSummaryBox.classList.add("likely")),el.rainSummaryBox&&(el.rainSummaryBox.classList.remove("rainy","likely"),i>=RAIN_MM_HIGHLIGHT&&el.rainSummaryBox.classList.add("rainy"))}function startTodaySkeleton(){if(el.todaySection&&el.todayRow){el.todaySection.classList.remove("hidden"),el.todayEmpty?.classList.add("hidden"),el.todayRow.innerHTML="";for(let e=0;e<6;e++){const e=document.createElement("div");e.className="forecast-card",e.innerHTML='\n      <div class="skel skel-line-sm" style="width:60%;height:14px;margin:0 auto 10px"></div>\n      <div class="skel skel-square" style="width:48px;height:48px;margin:0 auto;border-radius:12px"></div>\n      <div class="skel skel-line-sm" style="width:70%;height:14px;margin:10px auto 6px"></div>\n      <div class="skel skel-line-sm" style="width:80%;height:14px;margin:0 auto"></div>\n    ',el.todayRow.appendChild(e)}}}function renderTodayForecast(e){if(!el.todaySection||!el.todayRow)return;const t=e.city?.timezone||0,n=dateKeyISO(new Date(Date.now()+1e3*t)),o=(e.list||[]).filter((e=>dateKeyISO(toLocalDate(e.dt,t))===n));if(el.todayRow.innerHTML="",!o.length)return el.todayEmpty?.classList.remove("hidden"),void el.todaySection.classList.remove("hidden");el.todayEmpty?.classList.add("hidden");const a="imperial"===getUnits()?"Â°F":"Â°C";let i=!1;o.forEach((e=>{const n=pad(toLocalDate(e.dt,t).getUTCHours()),o=e.weather?.[0]?.icon||"01d",s=e.weather?.[0]?.description||"",r="number"==typeof e.main?.temp?`${Math.round(e.main.temp)}${a}`:"â€”",l="number"==typeof e.pop?Math.round(100*e.pop):0,c=e.rain&&"number"==typeof e.rain["3h"]?e.rain["3h"]:0;(l>0||c>0)&&(i=!0);const d=document.createElement("div");let m="forecast-card today-card";c>0?m+=" rainy":l>=POP_HIGHLIGHT&&(m+=" likely"),d.className=m;const u=document.createElement("div");u.className="forecast-time",u.textContent=`${n}:00`;const y=new Image;y.src=`https://openweathermap.org/img/wn/${o}@2x.png`,y.className="f-icon",y.loading="lazy",y.decoding="async",y.width=48,y.height=48;const h=document.createElement("div");h.className="forecast-temp",h.textContent=r;const p=document.createElement("div");p.className="forecast-desc",p.textContent=capitalize(s);const g=document.createElement("div");g.className="forecast-pop",g.textContent=`ðŸŒ§ï¸ ${l}% de chance`;const f=[u,y,h,p,g];if(c>0){const e=document.createElement("div");e.className="forecast-rain",e.textContent=`ðŸ’§ ${c.toFixed(1)} mm`,f.push(e)}d.replaceChildren(...f),el.todayRow.appendChild(d)})),el.todaySection.classList.remove("hidden"),el.todayNoRain&&(i?el.todayNoRain.classList.add("hidden"):el.todayNoRain.classList.remove("hidden"))}function loadHistory(){try{return JSON.parse(localStorage.getItem("cityHistory")||"[]")}catch{return[]}}function saveHistory(e){localStorage.setItem("cityHistory",JSON.stringify(e))}function addCityToHistory(e){if(!e)return;const t=loadHistory();saveHistory([e,...t.filter((t=>t.toLowerCase()!==e.toLowerCase()))].slice(0,5)),renderHistory()}function renderHistory(){if(!el.historyList)return;const e=loadHistory();if(!e.length)return el.historyList.classList.add("hidden"),void(el.historyList.innerHTML="");el.historyList.classList.remove("hidden");const t=document.createDocumentFragment();e.forEach((e=>{const n=document.createElement("button");n.className="chip",n.setAttribute("data-city",e),n.title=e,n.textContent=e,t.appendChild(n)})),el.historyList.innerHTML="",el.historyList.appendChild(t)}function wireEvents(){let e;el.searchBtn.addEventListener("click",(()=>fetchWeatherByCity(el.cityInput.value))),el.cityInput.addEventListener("keydown",(e=>{"Enter"===e.key&&fetchWeatherByCity(el.cityInput.value)})),el.geoBtn.addEventListener("click",(async()=>{if(navigator.geolocation){try{if(navigator.permissions&&navigator.permissions.query){if("denied"===(await navigator.permissions.query({name:"geolocation"})).state)return void showToast("PermissÃ£o de localizaÃ§Ã£o negada no navegador.","error")}}catch(e){}navigator.geolocation.getCurrentPosition((e=>{const{latitude:t,longitude:n}=e.coords;fetchWeatherByCoords(t,n)}),(e=>{e&&1===e.code?showToast("PermissÃ£o de localizaÃ§Ã£o negada.","error"):e&&2===e.code?showToast("LocalizaÃ§Ã£o indisponÃ­vel.","error"):e&&3===e.code?showToast("Tempo esgotado ao obter localizaÃ§Ã£o.","error"):showToast("NÃ£o foi possÃ­vel acessar a localizaÃ§Ã£o.","error")}),{enableHighAccuracy:!1,timeout:1e4,maximumAge:6e4})}else showToast("GeolocalizaÃ§Ã£o nÃ£o suportada.","error")})),el.themeToggle.addEventListener("click",cycleTheme),el.unitToggle&&el.unitToggle.addEventListener("click",toggleUnits),window.addEventListener("beforeinstallprompt",(t=>{t.preventDefault(),e=t,el.installBtn&&el.installBtn.classList.remove("hidden")})),el.installBtn&&el.installBtn.addEventListener("click",(async()=>{if(e){e.prompt();try{await e.userChoice}catch{}e=null,el.installBtn.classList.add("hidden")}})),window.addEventListener("appinstalled",(()=>{el.installBtn&&el.installBtn.classList.add("hidden")})),window.addEventListener("offline",(()=>showToast("VocÃª estÃ¡ offline.","error",2500))),window.addEventListener("online",(()=>showToast("ConexÃ£o restabelecida.","info",1800)))}function initTheme(){setTheme(localStorage.getItem("themePref")||"auto")}function initApp(){initTheme(),setupDynamicSections(),renderHistory(),updateUnitToggleUI(),wireEvents();const e=localStorage.getItem("lastCity");e?(el.cityInput.value=e,fetchWeatherByCity(e)):(el.statusMsg.textContent="Pesquise uma cidade",clearWeatherCard())}window.showUpdateBanner=window.showUpdateBanner||function(){const e=document.getElementById("updateBanner");if(!e)return;e.classList.remove("hidden");const t=document.getElementById("reloadBtn");t&&"serviceWorker"in navigator&&(t.onclick=async()=>{try{const e=await navigator.serviceWorker.getRegistration();e?.waiting?e.waiting.postMessage("SKIP_WAITING"):e?.active&&e.active.postMessage("SKIP_WAITING")}catch{}let e=!1;navigator.serviceWorker.addEventListener("controllerchange",(()=>{e||(e=!0,window.location.reload())}))})},document.addEventListener("DOMContentLoaded",initApp);